!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.Flat=e.Flat||{},e.Flat.Embed=t())}(this,function(){"use strict";function e(e,t,n){if(!e.element.contentWindow||!e.element.contentWindow.postMessage)throw new Error("No `contentWindow` or `contentWindow.postMessage` avaialble on the element");e.element.contentWindow.postMessage({method:t,parameters:n},e.origin)}if(void 0===window.postMessage)throw new Error("The Flat Embed JS API is not supported in this browser");var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t){return n(this,e),this.embed=t,this.promises={},this.eventCallbacks={},this}return r(e,[{key:"pushCall",value:function(e,t,n){this.promises[e]=this.promises[e]||[],this.promises[e].push({resolve:t,reject:n})}},{key:"subscribeEvent",value:function(e,t){return this.eventCallbacks[e]=this.eventCallbacks[e]||[],this.eventCallbacks[e].push(t),1===this.eventCallbacks[e].length}},{key:"unsubscribeEvent",value:function(e,t){if(!this.eventCallbacks[e])return!1;if(t){var n=this.eventCallbacks[e].indexOf(t);n>=0&&this.eventCallbacks[e].splice(n,1)}else this.eventCallbacks[e]=[];return!t||0===this.eventCallbacks[e].length}},{key:"process",value:function(e){e.method?this.processMethodResponse(e):e.event&&this.processEvent(e)}},{key:"processMethodResponse",value:function(e){var t=this.promises[e.method].shift();t&&(e.error?t.reject(e.error):t.resolve(e.response))}},{key:"processEvent",value:function(e){var t=this;this.eventCallbacks[e.event]&&0!==this.eventCallbacks[e.event].length&&this.eventCallbacks[e.event].forEach(function(n){n.call(t.embed,e.parameters)})}}]),e}(),i=new WeakMap,s=new WeakMap;return function(){function a(t){var r=this,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(n(this,a),t=function(e){if(window.jQuery&&e instanceof window.jQuery&&(e=e[0]),"string"==typeof e&&(e=document.getElementById(e)),!(e instanceof window.HTMLElement))throw new TypeError("The first parameter must be an existing DOM element or an identifier.");if("IFRAME"!==e.nodeName){var t=e.querySelector("iframe");t&&(e=t)}return e}(t),i.has(t))return i.get(t);"IFRAME"!==t.nodeName&&(t=function(e,t){var n=function(e){var t=e.baseUrl||"https://flat.io/embed";t+="/"+(e.score||"blank");var n=Object.assign({jsapi:!0},e.embedParams);return t+"?"+Object.keys(n).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&")}(t),r=document.createElement("iframe");return r.setAttribute("src",n),r.setAttribute("width",t.width||"100%"),r.setAttribute("height",t.height||"100%"),r.setAttribute("allowfullscreen",!0),r.setAttribute("frameborder","0"),e.appendChild(r),r}(t,u)),this.origin="*",this.element=t,this.embedCallback=new o;var l=new Promise(function(n){window.addEventListener("message",function(e){if(t.contentWindow===e.source){"*"===r.origin&&(r.origin=e.origin);var o=function(e){return"string"==typeof e&&(e=JSON.parse(e)),e}(e.data);"ready"!==o.event&&"ping"!==o.method?r.embedCallback.process(o):n()}},!1),e(r,"ping")});return i.set(this.element,this),s.set(this,l),this}return r(a,[{key:"ready",value:function(){return Promise.resolve(s.get(this))}},{key:"call",value:function(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(o,i){return n.ready().then(function(){n.embedCallback.pushCall(t,o,i),e(n,t,r)})})}},{key:"on",value:function(e,t){if("string"!=typeof e)throw new TypeError("An event name (string) is required");if("function"!=typeof t)throw new TypeError("An callback (function) is required");this.embedCallback.subscribeEvent(e,t)&&this.call("addEventListener",e).catch(function(){})}},{key:"off",value:function(e,t){if("string"!=typeof e)throw new TypeError("An event name (string) is required");this.embedCallback.unsubscribeEvent(e,t)&&this.call("removeEventListener",e).catch(function(){})}},{key:"loadFlatScore",value:function(e,t){return this.call("loadFlatScore",{score:e,revision:t})}},{key:"loadMusicXML",value:function(e){return this.call("loadMusicXML",e)}},{key:"loadJSON",value:function(e){return this.call("loadJSON",e)}},{key:"getJSON",value:function(){return this.call("getJSON")}},{key:"getMusicXML",value:function(e){var n=this;return new Promise(function(r,o){if("object"!==(void 0===(e=e||{})?"undefined":t(e)))return o(new TypeError("Options must be an object"));n.call("getMusicXML",e).then(function(e){return r("string"==typeof e?e:new Uint8Array(e.data))}).catch(o)})}},{key:"getPNG",value:function(e){var n=this;return new Promise(function(r,o){if("object"!==(void 0===(e=e||{})?"undefined":t(e)))return o(new TypeError("Options must be an object"));n.call("getPNG",e).then(function(e){return r("string"==typeof e?e:new Uint8Array(e))}).catch(o)})}},{key:"getFlatScoreMetadata",value:function(){return this.call("getFlatScoreMetadata")}},{key:"getEmbedConfig",value:function(){return this.call("getEmbedConfig")}},{key:"setEditorConfig",value:function(e){return this.call("setEditorConfig",e)}},{key:"fullscreen",value:function(e){return this.call("fullscreen",e)}},{key:"play",value:function(){return this.call("play")}},{key:"pause",value:function(){return this.call("pause")}},{key:"stop",value:function(){return this.call("stop")}},{key:"mute",value:function(){return this.call("mute")}},{key:"print",value:function(){return this.call("print")}},{key:"getZoom",value:function(){return this.call("getZoom")}},{key:"setZoom",value:function(e){return this.call("setZoom",e)}},{key:"getAutoZoom",value:function(){return this.call("getAutoZoom")}},{key:"setAutoZoom",value:function(e){return this.call("setAutoZoom",e)}},{key:"focusScore",value:function(){return this.call("focusScore")}},{key:"getCursorPosition",value:function(){return this.call("getCursorPosition")}},{key:"setCursorPosition",value:function(e){return this.call("setCursorPosition",e)}},{key:"edit",value:function(e){return this.call("edit",e)}},{key:"setNoteColor",value:function(e,t){return this.call("setNoteColor",{note:e,color:t})}}]),a}()});